(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[185],{5410:function(){},8628:function(){},1601:function(){},7792:function(){},4977:function(){},5042:function(){},8101:function(e,t,r){Promise.resolve().then(r.bind(r,4140))},4140:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return RootLayout}});var i=r(7437),n=r(8771),a=r(2710),s=r(9792),u=r(245);let isMyCaptured=e=>e<u.Rg,isOpCaptured=e=>e>=u.Rg,keyValidation=e=>u.s3.test(e)?(0,s.ok)(void 0):(0,s.cn)(Error());let Captured=class Captured{getCapturedIndex(){return this.capturedIndex}getAmount(){return this.amount}setAmount(e){return new Captured(this.capturedIndex,e)}getKey(){return this.amount.toString()}constructor(e,t=0){this.capturedIndex=e,this.amount=t}};let Square=class Square{getPiece(){return this.piece}getIndex(){return this.index}isEmpty(){return(0,a.xb)(this.piece)}isPieceExists(){return!this.isEmpty()}setPiece(e){return new Square(this.index,e)}getKey(){return 10!==this.piece?this.piece.toString():"a"}turnState(){let e=(0,a.xb)(this.piece)?u.E_:(0,a.y3)(this.piece)?this.piece+5:this.piece-5;return new Square(this.index,e)}constructor(e,t=u.E_){this.index=e,this.piece=t}};let ShogiState=class ShogiState{static createInitialState(){let e=u.Bu.map((e,t)=>new Square(t,e)),t=u.o.map((e,t)=>new Captured(t,e));return new ShogiState(e,t)}static parseKey(e){let t=e.slice(0,12),r=e.slice(12),i=t.split("").map((e,t)=>new Square(t,"a"!==e?Number(e):10)),n=r.split("").map((e,t)=>new Captured(t,Number(e)));return keyValidation(e).map(()=>new ShogiState(i,n))}getKey(){let e=this.board.map(e=>e.getKey()).join(""),t=this.captured.map(e=>e.getKey()).join("");return e+t}getPiece(e){return this.board[e].getPiece()}getAmount(e){return this.captured[e].getAmount()}movePiece(e,t){let r=this.board[e],i=this.board[t],n=r.setPiece(u.E_),o=i.setPiece(r.getPiece()),c=this.canMovePiece(r.getPiece(),e,t),l=i.isEmpty()||(0,a.Ww)(i.getPiece())?(0,s.ok)(this.captured):this.catchPiece(i.getPiece()),h=(()=>{let i=[...this.board];return i[e]=n,r.getPiece()===u.ZI&&t<3?i[t]=o.setPiece(u.Pn):r.getPiece()===u.Xs&&t>8?i[t]=o.setPiece(u.mh):i[t]=o,(0,s.ok)(i)})();return s.x4.combine([c,h,l]).map(e=>{let[t,r,i]=e;return new ShogiState(r,i)})}putPiece(e,t){let r=this.useCaptured(e),i=this.board[t];if(!i.isEmpty())return(0,s.cn)(Error());let n=(()=>{let r=(()=>{switch(e){case u.bD:return u.OS;case u.IH:return u.Vg;case u.Ah:return u.ZI;case u.Rg:return u.zq;case u.rD:return u.Dx;case u.y8:return u.Xs}})();if(void 0===r)return(0,s.cn)(Error());let n=[...this.board];return n[t]=i.setPiece(r),(0,s.ok)(n)})();return s.x4.combine([n,r]).map(e=>{let[t,r]=e;return new ShogiState(t,r)})}canMovePiece(e,t,r){let i=this.board[r];if((0,a.xb)(e)||(0,a.y3)(e)&&(0,a.y3)(i.getPiece())||(0,a.XE)(e)&&(0,a.XE)(i.getPiece()))return(0,s.cn)(Error());let n=ShogiState.getMove(e,t);return n.includes(r)?(0,s.ok)(void 0):(0,s.cn)(Error())}getNextStates(e){let t="ME"===e?a.y3:a.XE,r=this.board.map((e,r)=>t(e.getPiece())?Array(12).fill(void 0).map((e,t)=>{let i=this.movePiece(r,t);return i.isOk()?[i.value]:[]}).flat():[]).flat(),i="ME"===e?isMyCaptured:isOpCaptured,n=this.captured.map((e,t)=>i(t)&&0!==e.getAmount()?Array(12).fill(void 0).map((e,r)=>{let i=this.putPiece(t,r);return i.isOk()?[i.value]:[]}).flat():[]).flat();return[...r,...n]}isFinished(e){let t={isFinished:!0,winner:"ME"},r={isFinished:!0,winner:"OPPONENT"},i=this.board.findIndex(e=>e.getPiece()===u.xw),n=this.board.findIndex(e=>e.getPiece()===u.D_);return -1===i?r:-1===n?t:"ME"===e&&i<3?t:"OPPONENT"===e&&n>8?r:{isFinished:!1}}turnState(){let e=this.board.reverse().map(e=>e.turnState()),t=[...this.captured.slice(3),...this.captured.slice(0,3)];return new ShogiState(e,t)}catchPiece(e){let t=(()=>{switch(e){case u.zq:return u.bD;case u.Dx:return u.IH;case u.Xs:case u.mh:return u.Ah;case u.OS:return u.Rg;case u.Vg:return u.rD;case u.ZI:case u.Pn:return u.y8}})();if(void 0===t)return(0,s.cn)(Error());let r=this.captured[t],i=r.setAmount(r.getAmount()+1);return(0,s.ok)([...this.captured.slice(0,t),i,...this.captured.slice(t+1)])}useCaptured(e){let t=this.captured[e],r=t.getAmount();if(0===r)return(0,s.cn)(Error());let i=t.setAmount(r-1);return(0,s.ok)([...this.captured.slice(0,e),i,...this.captured.slice(e+1)])}static getMove(e,t){let r=(()=>{switch(e){case u.ZI:if(t>2)return[-3];break;case u.Xs:if(t<9)return[3];break;case u.xw:case u.D_:if(0===t)return[1,3,4];if(1===t)return[-1,1,2,3,4];if(2===t)return[-1,2,3];if(3===t||6===t)return[-3,-2,1,3,4];else if(4===t||7===t)return[-4,-3,-2,-1,1,2,3,4];else if(5===t||8===t)return[-4,-3,-1,2,3];else if(9===t)return[-3,-2,1];else if(10===t)return[-4,-3,-2,-1,1];else if(11===t)return[-4,-3,-1];case u.OS:case u.zq:if(0===t)return[4];if(1===t)return[2,4];if(2===t)return[2];if(3===t||6===t)return[-2,4];else if(4===t||7===t)return[-4,-2,2,4];else if(5===t||8===t)return[-4,2];else if(9===t)return[-2];else if(10===t)return[-4,-2];else if(11===t)return[-4];case u.Vg:case u.Dx:if(0===t)return[1,3];if(1===t)return[-1,1,3];if(2===t)return[-1,3];if(3===t||6===t)return[-3,1,3];else if(4===t||7===t)return[-3,-1,1,3];else if(5===t||8===t)return[-3,-1,3];else if(9===t)return[-3,1];else if(10===t)return[-3,-1,1];else if(11===t)return[-3,-1];case u.Pn:if(0===t)return[1,3];if(1===t)return[-1,1,3];if(2===t)return[-1,3];if(3===t||6===t)return[-3,-2,1,3];else if(4===t||7===t)return[-4,-3,-2,-1,1,3];else if(5===t||8===t)return[-4,-3,-1,3];else if(9===t)return[-3,-2,1];else if(10===t)return[-4,-3,-2,-1,1];else if(11===t)return[-4,-3,-1];case u.mh:if(0===t)return[1,3,4];if(1===t)return[-1,1,2,3,4];if(2===t)return[-1,2,3];if(3===t||6===t)return[-3,1,3,4];else if(4===t||7===t)return[-3,-1,1,2,3,4];else if(5===t||8===t)return[-3,-1,2,3];else if(9===t)return[-3,1];else if(10===t)return[-3,-1,1];else if(11===t)return[-3,-1]}return[]})();return r.map(e=>t+e)}constructor(e,t){this.board=e,this.captured=t}};let GameState=class GameState{static createInitialState(){return new GameState}getTurnPlayer(){return this.turnPlayer}toggleTurn(){return new GameState("ME"===this.turnPlayer?"OPPONENT":"ME")}getSelectingAction(){return this.selectingAction}isFinished(){return"FINISHED"===this.finishStatus.type}getWinner(){return"NOTFINISH"===this.finishStatus.type?(0,s.cn)(Error()):(0,s.ok)(this.finishStatus.winner)}setFinishStatus(e){return new GameState(this.turnPlayer,this.selectingAction,{type:"FINISHED",winner:e})}setSelectingAction(e){if(this.isFinished())return(0,s.cn)(Error());switch(e.type){case"BOARD":{let t=this.boardValidateion(e);if(t.isErr())return(0,s.cn)(t.error);return(0,s.ok)(new GameState(this.turnPlayer,e))}case"CAPTURED":{let t=this.capturedValidateion(e);if(t.isErr())return(0,s.cn)(t.error);return(0,s.ok)(new GameState(this.turnPlayer,e))}case"NONE":return(0,s.ok)(new GameState(this.turnPlayer,e))}}clearSelectingAction(){return new GameState(this.turnPlayer,{type:"NONE"})}boardValidateion(e){return"ME"===this.turnPlayer?(0,a.y3)(e.piece)?(0,s.ok)(void 0):(0,s.cn)(Error()):(0,a.XE)(e.piece)?(0,s.ok)(void 0):(0,s.cn)(Error())}capturedValidateion(e){return"ME"===this.turnPlayer?isMyCaptured(e.capturedIndex)?(0,s.ok)(void 0):(0,s.cn)(Error()):isOpCaptured(e.capturedIndex)?(0,s.ok)(void 0):(0,s.cn)(Error())}constructor(e="ME",t={type:"NONE"},r={type:"NOTFINISH"}){this.turnPlayer=e,this.selectingAction=t,this.finishStatus=r}};let Game=class Game{static createInitialState(){return new Game(ShogiState.createInitialState(),GameState.createInitialState())}getSquareViewModel(e){let t=this.gameState.getSelectingAction(),r=this.shogiState.getPiece(e),i=(()=>{switch(t.type){case"NONE":return"inclickable";case"BOARD":{if(t.squareIndex===e)return"selecting";let r=this.shogiState.getPiece(t.squareIndex),i=this.shogiState.canMovePiece(r,t.squareIndex,e);return i.isOk()?"clickable":"inclickable"}case"CAPTURED":return(0,a.xb)(r)?"clickable":"inclickable"}})();return{piece:r,squareIndex:e,state:i}}getCapturedViewModel(e){let t=this.gameState.getSelectingAction(),r=this.shogiState.getAmount(e),i=(()=>{switch(t.type){case"NONE":case"BOARD":return"notselecting";case"CAPTURED":return e===t.capturedIndex?"selecting":"notselecting"}})();return{capturedIndex:e,amount:r,state:i}}getSystemViewModel(e){if(e)return{turnPlayer:"ME",finishStatus:{isFinished:!0,winner:"ME"},notStarted:!0,thinking:!1};let t=this.gameState.getWinner(),r=this.gameState.getTurnPlayer();return t.isErr()?{turnPlayer:r,finishStatus:{isFinished:!1},notStarted:!1,thinking:!1}:{turnPlayer:r,finishStatus:{isFinished:!0,winner:t.value},notStarted:!1,thinking:!1}}clickBoard(e){let t=this.shogiState.getPiece(e),r=this.gameState.getTurnPlayer(),i=this.gameState.getSelectingAction();switch(i.type){case"NONE":{let r=this.gameState.setSelectingAction({type:"BOARD",squareIndex:e,piece:t});if(r.isErr())return(0,s.cn)(r.error);return(0,s.ok)(new Game(this.shogiState,r.value))}case"BOARD":if(i.squareIndex===e)return(0,s.ok)(this.clearState());if("ME"===r&&(0,a.y3)(t)||"OPPONENT"===r&&(0,a.XE)(t)){let r=this.gameState.setSelectingAction({type:"BOARD",squareIndex:e,piece:t});if(r.isErr())return(0,s.cn)(r.error);return(0,s.ok)(new Game(this.shogiState,r.value))}{let t=this.shogiState.movePiece(i.squareIndex,e);if(t.isErr())return(0,s.cn)(t.error);return(0,s.ok)(this.turnEnd(t.value))}case"CAPTURED":if("ME"===r&&(0,a.y3)(t)||"OPPONENT"===r&&(0,a.XE)(t)){let r=this.gameState.setSelectingAction({type:"BOARD",squareIndex:e,piece:t});if(r.isErr())return(0,s.cn)(r.error);return(0,s.ok)(new Game(this.shogiState,r.value))}{let t=this.shogiState.putPiece(i.capturedIndex,e);if(t.isErr())return(0,s.cn)(t.error);return(0,s.ok)(this.turnEnd(t.value))}}}clickCaptured(e){let t=this.gameState.getSelectingAction();if("CAPTURED"===t.type&&t.capturedIndex===e)return(0,s.ok)(this.clearState());{let t=this.gameState.setSelectingAction({type:"CAPTURED",capturedIndex:e});return t.isErr()?(0,s.cn)(t.error):(0,s.ok)(new Game(this.shogiState,t.value))}}selectNextState(e,t){let r=this.shogiState.getNextStates(this.gameState.getTurnPlayer()).map(e=>"OPPONENT"===t?e:e.turnState()).map(e=>e.getKey()),i=e(r);if(i.isErr())return(0,s.cn)(i.error);let n=ShogiState.parseKey(i.value);if(n.isErr())return(0,s.cn)(n.error);let a="OPPONENT"===t?n.value:n.value.turnState();return(0,s.ok)(this.turnEnd(a))}isFinished(){return this.gameState.isFinished()}getTurnPlayer(){return this.gameState.getTurnPlayer()}turnEnd(e){let t=this.gameState.toggleTurn(),r=e.isFinished(t.getTurnPlayer());return r.isFinished?new Game(e,t.setFinishStatus(r.winner)):new Game(e,t)}clearState(){return new Game(this.shogiState,this.gameState.clearSelectingAction())}constructor(e,t){this.shogiState=e,this.gameState=t}};var o=r(7795),c=r.n(o);let l="click",h="game";let GameListener=class GameListener extends c(){emitGameEvent(e){this.emit(h,e)}onGameEvent(e){this.on(h,e)}emitClickEvent(e){this.emit(l,e)}onClickEvent(e){this.on(l,e)}};let StateListener=class StateListener extends c(){emitSquareViewModel(e,t){let r=this.squareCache.get(e);JSON.stringify(r)!==JSON.stringify(t)&&(this.squareCache.set(e,t),this.emit(this.makeSquareViewModelEventName(e),t))}onSquareViewModel(e,t){this.on(this.makeSquareViewModelEventName(e),t)}removeSquareViewModelListener(e,t){this.removeListener(this.makeSquareViewModelEventName(e),t)}emitCapturedViewModel(e,t){let r=this.capturedCache.get(e);JSON.stringify(r)!==JSON.stringify(t)&&(this.capturedCache.set(e,t),this.emit(this.makeCapturedViewModelEventName(e),t))}onCapturedViewModel(e,t){this.on(this.makeCapturedViewModelEventName(e),t)}removeCapturedViewModelListener(e,t){this.removeListener(this.makeCapturedViewModelEventName(e),t)}emitSystemViewModel(e){JSON.stringify(this.systemCache)!==JSON.stringify(e)&&(this.systemCache=e,this.emit(this.makeSystemViewModelEventName(),e))}onSystemViewModel(e){this.on(this.makeSystemViewModelEventName(),e)}removeSystemViewModelListener(e){this.removeListener(this.makeSystemViewModelEventName(),e)}makeSquareViewModelEventName(e){return"SQUARE_VIEW_MODEL"+e.toString()}makeCapturedViewModelEventName(e){return"CAPTURED_VIEW_MODEL"+e.toString()}makeSystemViewModelEventName(){return"SYSTEM_VIEW_MODEL"}constructor(...e){super(...e),this.squareCache=new Map,this.capturedCache=new Map,this.systemCache=void 0}};var d=r(6420),m=r(9743),g=r.n(m);let ModelData=class ModelData{static createData(e){let t=e.slice(0,12),r=e.slice(12),i=t.split("").map(e=>"a"!==e?Number(e):10).map(e=>ModelData.createOnehot(e,11)).flat(),n=r.split("").map(e=>Number(e)).map(e=>ModelData.createOnehot(e,3)).flat(),a=(0,d.XeE)([...i,...n],[1,150],"float32");return keyValidation(e).map(()=>new ModelData(e,a))}static createOnehot(e,t){let r=Array(t).fill(0);return r[e]=1,r}getData(){return this.data}getKey(){return this.key}constructor(e,t){this.key=e,this.data=t}};let Model=class Model{static async load(e){let t=await (0,d.FBF)(g().join(u.GW,"/models",e,"model.json"));return new Model(t,e)}getChooseStrategy(){return e=>{let t=0,r=1/0;for(let i=0;i<e.length;i++){let n=e[i],a=this.predict(n);if(a.isErr())return(0,s.cn)(a.error);let u=a.value;u<r&&(t=i,r=u)}return(0,s.ok)(e[t])}}predict(e){if(this.cache.has(e))return(0,s.ok)(this.cache.get(e));let t=ModelData.createData(e);if(t.isErr())return(0,s.cn)(t.error);let r=this.model.predict(t.value.getData()),i=r.arraySync()[0][0];return this.cache.set(e,i),(0,s.ok)(i)}constructor(e,t){this.model=e,this.modelName=t,this.cache=new Map}};let System=class System{getGame(){return this.game}getGameListener(){return this.gameListner}getStateListener(){return this.stateListener}init(){this.gameListner.onGameEvent(e=>{switch(e.type){case"start":{this.game=Game.createInitialState();let loadModelHandler=e=>{e.isOk()&&this.loadModel(e.value)};loadModelHandler(e.playType.me.getModelName()),loadModelHandler(e.playType.opponent.getModelName()),this.playTypes=e.playType;break}case"reset":this.game=Game.createInitialState()}this.notStarted=!1,this.emitEvents()}),this.gameListner.onClickEvent(e=>{if(!this.notStarted&&"STRATEGY"!==this.getPlayType(this.game.getTurnPlayer()).getPlayStrategy()){switch(e.type){case"BOARD":{let t=this.game.clickBoard(e.squareIndex);if(t.isErr())return;this.game=t.value;break}case"CAPTURED":{let t=this.game.clickCaptured(e.capturedIndex);if(t.isErr())return;this.game=t.value}}this.emitEvents()}}),this.modelListener.onStrategyEvent(e=>{let t=this.getPlayType(e.turnPlayer).getModelName();if(t.isErr())return;let r=t.value,i=this.models.get(r);if(void 0===i){console.log("model not found: "+r),setTimeout(()=>{this.modelListener.emitStrategyEvent(e)},1500);return}let n=this.game.selectNextState(i.getChooseStrategy(),e.turnPlayer);n.isErr()||(this.game=n.value,this.emitEvents())})}emitEvents(){for(let e=0;e<12;e++)this.stateListener.emitSquareViewModel(e,this.getSquareViewModel(e));for(let e=0;e<6;e++)this.stateListener.emitCapturedViewModel(e,this.getCapturedViewModel(e));this.stateListener.emitSystemViewModel(this.getSystemViewModel());let e=this.game.getTurnPlayer();"STRATEGY"!==this.getPlayType(e).getPlayStrategy()||this.game.isFinished()||setTimeout(()=>{this.modelListener.emitStrategyEvent({turnPlayer:this.game.getTurnPlayer()})},1500)}getSquareViewModel(e){return this.game.getSquareViewModel(e)}getCapturedViewModel(e){return this.game.getCapturedViewModel(e)}getSystemViewModel(){let e=this.game.getSystemViewModel(this.notStarted),t="STRATEGY"===this.getPlayType(this.game.getTurnPlayer()).getPlayStrategy();return{...e,thinking:t}}getPlayType(e){return"ME"===e?this.playTypes.me:this.playTypes.opponent}loadModel(e){this.models.has(e)||Model.load(e).then(t=>{console.log("load model: "+e),this.models.set(e,t)})}constructor(e,t,r,i,n,a){this.gameListner=e,this.stateListener=t,this.modelListener=r,this.models=new Map,this.notStarted=!0,this.game=i,this.playTypes={me:n,opponent:a},this.init()}};let ModelListener=class ModelListener extends c(){emitStrategyEvent(e){this.emit(this.makeStrategyEventName(),e)}onStrategyEvent(e){this.on(this.makeStrategyEventName(),e)}removeStrategyEventListener(e){this.removeListener(this.makeStrategyEventName(),e)}makeStrategyEventName(){return"strategy"}};var S=r(3842);function RootLayout(e){let{children:t}=e;return(0,i.jsx)(n.y.Provider,{value:new System(new GameListener,new StateListener,new ModelListener,Game.createInitialState(),new S.S("CLICK"),new S.S("CLICK")),children:(0,i.jsx)("html",{lang:"jp",children:(0,i.jsx)("body",{children:t})})})}},245:function(e,t,r){"use strict";r.d(t,{Ah:function(){return p},Bu:function(){return P},D_:function(){return c},Dx:function(){return h},E_:function(){return i},GW:function(){return M},IH:function(){return S},OS:function(){return a},Pn:function(){return o},Rg:function(){return y},Vg:function(){return s},Xs:function(){return d},ZI:function(){return u},bD:function(){return g},mh:function(){return m},o:function(){return w},rD:function(){return f},s3:function(){return v},xw:function(){return n},y8:function(){return E},zq:function(){return l}});let i=0,n=1,a=2,s=3,u=4,o=5,c=6,l=7,h=8,d=9,m=10,g=0,S=1,p=2,y=3,f=4,E=5,P=[h,c,l,i,d,i,i,u,i,a,n,s],w=[0,0,0,0,0,0],v=/([0-9]|a){12}[0-2]{6}/,M="/dobutsu_front"},3842:function(e,t,r){"use strict";r.d(t,{S:function(){return PlayType}});var i=r(9792);let PlayType=class PlayType{getPlayStrategy(){return this.playStrategy}getModelName(){return void 0!==this.modelName?(0,i.ok)(this.modelName):(0,i.cn)(Error())}constructor(e,t){this.playStrategy=e,this.modelName=t}}},8771:function(e,t,r){"use strict";r.d(t,{O:function(){return useGlobal},y:function(){return n}});var i=r(2265);let n=(0,i.createContext)(void 0),useGlobal=()=>{let e=(0,i.useContext)(n);return{game:e.getGame(),gameListener:e.getGameListener(),stateListener:e.getStateListener()}}},2710:function(e,t,r){"use strict";r.d(t,{Ww:function(){return isLion},XE:function(){return isOpPiece},xb:function(){return isEmpty},y3:function(){return isMyPiece}});var i=r(245);let isMyPiece=e=>e!==i.E_&&e<i.D_,isOpPiece=e=>e>=i.D_,isEmpty=e=>e===i.E_,isLion=e=>e===i.xw||e===i.D_}},function(e){e.O(0,[425,399,663,566,967,636,938,498,263,971,472,744],function(){return e(e.s=8101)}),_N_E=e.O()}]);